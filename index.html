<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合再平衡計算機</title>
    
    <!-- 引入必要的 CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const RebalanceCalculator = () => {
            const [assets, setAssets] = React.useState([
                { name: '股票', current: '', target: '70', amount: 0, adjustAmount: 0, risk: 1.0 },
                { name: '現金', current: '', target: '30', amount: 0, adjustAmount: 0, risk: 0.0 }
            ]);

            const [riskProfile, setRiskProfile] = React.useState('moderate');
            
            const riskProfiles = {
                conservative: { name: '保守型', stockTarget: 50, description: '適合風險承受度低的投資者' },
                moderate: { name: '穩健型', stockTarget: 70, description: '適合可承受中等風險的投資者' },
                aggressive: { name: '積極型', stockTarget: 90, description: '適合風險承受度高的投資者' }
            };

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('zh-TW', {
                    style: 'decimal',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            };

            const calculateRiskExposure = (assets) => {
                const total = assets.reduce((sum, asset) => sum + Number(asset.current), 0);
                const weightedRisk = assets.reduce((sum, asset) => {
                    const weight = Number(asset.current) / total;
                    return sum + (weight * asset.risk);
                }, 0);
                return (weightedRisk * 100).toFixed(1);
            };

            const updateTargetsBasedOnRisk = (profile) => {
                const stockTarget = riskProfiles[profile].stockTarget;
                const newAssets = [...assets];
                newAssets[0].target = stockTarget;
                newAssets[1].target = 100 - stockTarget;
                setAssets(newAssets);
            };

            const calculateRebalance = () => {
                const total = assets.reduce((sum, asset) => sum + Number(asset.current), 0);
                
                return assets.map(asset => {
                    const currentPercentage = (Number(asset.current) / total * 100);
                    const targetAmount = (total * Number(asset.target) / 100);
                    const adjustAmount = targetAmount - Number(asset.current);
                    
                    return {
                        ...asset,
                        currentPercentage: currentPercentage.toFixed(1),
                        amount: targetAmount,
                        adjustAmount: adjustAmount
                    };
                });
            };

            const handleCalculate = () => {
                const results = calculateRebalance();
                setAssets(results);
            };

            const handleInputChange = (index, field, value) => {
                const newAssets = [...assets];
                newAssets[index][field] = value;
                setAssets(newAssets);
            };

            const handleRiskProfileChange = (value) => {
                setRiskProfile(value);
                updateTargetsBasedOnRisk(value);
            };

            const totalAmount = assets.reduce((sum, asset) => sum + Number(asset.current) || 0, 0);
            const currentRiskExposure = calculateRiskExposure(assets);

            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-xl mx-auto bg-white rounded-lg shadow p-6">
                        <h1 className="text-2xl font-bold text-center mb-6">投資組合再平衡計算機</h1>
                        
                        <div className="space-y-6">
                            <div className="space-y-2">
                                <label className="block text-sm font-medium">選擇風險承受度：</label>
                                <select 
                                    className="w-full p-2 border rounded"
                                    value={riskProfile}
                                    onChange={(e) => handleRiskProfileChange(e.target.value)}
                                >
                                    {Object.entries(riskProfiles).map(([key, profile]) => (
                                        <option key={key} value={key}>{profile.name}</option>
                                    ))}
                                </select>
                                <p className="text-sm text-gray-600">{riskProfiles[riskProfile].description}</p>
                            </div>

                            <div className="text-lg font-medium flex justify-between">
                                <span>總投資金額: {formatCurrency(totalAmount)} 元</span>
                                <span>目前風險曝險: {currentRiskExposure}%</span>
                            </div>

                            <div className="space-y-4">
                                {assets.map((asset, index) => (
                                    <div key={asset.name} className="grid grid-cols-3 gap-4 items-center">
                                        <div>{asset.name}</div>
                                        <div>
                                            <input
                                                type="number"
                                                className="w-full p-2 border rounded"
                                                value={asset.current}
                                                onChange={(e) => handleInputChange(index, 'current', e.target.value)}
                                                placeholder="輸入金額"
                                            />
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded"
                                                value={asset.target}
                                                onChange={(e) => handleInputChange(index, 'target', e.target.value)}
                                            />
                                            <span>%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <button
                                onClick={handleCalculate}
                                className="w-full py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                            >
                                計算再平衡
                            </button>

                            {assets[0].adjustAmount !== 0 && (
                                <div className="mt-6 space-y-4 bg-gray-50 p-4 rounded-lg">
                                    <div className="font-medium text-lg">目前資產配置:</div>
                                    {assets.map(asset => (
                                        <div key={asset.name} className="flex justify-between">
                                            <span>{asset.name}:</span>
                                            <span>{asset.currentPercentage}%</span>
                                        </div>
                                    ))}

                                    <div className="text-sm text-gray-600 mt-2">
                                        調整後預計風險曝險: {(assets[0].target * assets[0].risk).toFixed(1)}%
                                    </div>

                                    <div className="font-medium text-lg mt-6">調整建議:</div>
                                    {assets.map(asset => (
                                        <div key={asset.name} className="flex justify-between items-center">
                                            <span>{asset.name}</span>
                                            <div className="text-right">
                                                <div className={asset.adjustAmount > 0 ? 'text-green-600' : 'text-red-600'}>
                                                    {asset.adjustAmount > 0 ? '買入' : '賣出'} {formatCurrency(Math.abs(asset.adjustAmount))} 元
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    目標金額: {formatCurrency(asset.amount)} 元
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 渲染應用
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RebalanceCalculator />);
    </script>
</body>
</html>
